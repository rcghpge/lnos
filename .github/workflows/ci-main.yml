name: LnOS CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Runs at midnight 00:00 UTC every Friday for maintenance
    - cron: '0 0 * * 5' 
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  validate:
    name: Validate Repository
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate build scripts exist
        run: |
          echo "ðŸ” Validating build scripts..."
          for script in build-iso.sh build-arm-image.sh build-arm-minimal.sh; do
            if [ -f "$script" ]; then
              echo "âœ… $script exists"
              chmod +x "$script"
            else
              echo "âŒ $script missing"
              exit 1
            fi
          done

      - name: Validate GPG key exists
        run: |
          echo "ðŸ” Validating GPG setup..."
          if [ -f "keys/lnos-public-key.asc" ]; then
            echo "âœ… GPG public key exists"
            # Validate key format
            gpg --import keys/lnos-public-key.asc
            gpg --list-keys 9486759312876AD7 >/dev/null 2>&1 && echo "âœ… GPG key valid"
          else
            echo "âŒ GPG public key missing"
            exit 1
          fi

      - name: Validate archiso configuration
        run: |
          echo "ðŸ” Validating archiso configuration..."
          if [ -d "archiso" ]; then
            echo "âœ… archiso directory exists"
            for file in packages.x86_64 profiledef.sh; do
              if [ -f "archiso/$file" ]; then
                echo "âœ… archiso/$file exists"
              else
                echo "âŒ archiso/$file missing"
                exit 1
              fi
            done
          else
            echo "âŒ archiso directory missing"
            exit 1
          fi

  update-status:
    name: Update Build Status
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update build status
        run: |
          echo "# Build completed $(date)" > build-status.md
          echo "" >> build-status.md
          echo "Last validated: $(date -u)" >> build-status.md
          echo "Commit: ${{ github.sha }}" >> build-status.md

      - name: Commit status update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet build-status.md; then
            echo "No changes to build status"
          else
            git add build-status.md
            git commit -m "Update build status [skip ci]"
            git push
          fi

