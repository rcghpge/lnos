name: Generate README Badges

on:
  push:
    branches: [main, sandbox, merge]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme-badges:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Inject branch-specific badge block into docs/README.md
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          README="docs/README.md"

          if [ ! -f "$README" ]; then
            echo "‚ùå $README not found"
            exit 1
          fi

          case "$BRANCH" in
            main)
              CI_LABEL="LnOS CI/CD"
              CI_FILE="ci-main"
              ;;
            sandbox)
              CI_LABEL="Sandbox"
              CI_FILE="ci-sandbox"
              ;;
            merge)
              CI_LABEL="Merge"
              CI_FILE="ci-merge"
              ;;
            *)
              echo "‚ö†Ô∏è Unknown branch: $BRANCH"
              exit 0
              ;;
          esac

          echo "üì¶ Generating badge block for $BRANCH..."

          BADGE_BLOCK=$(cat <<EOF
# lnos

[![${CI_LABEL}](https://github.com/rcghpge/lnos/actions/workflows/${CI_FILE}.yml/badge.svg)](https://github.com/rcghpge/lnos/actions/workflows/${CI_FILE}.yml)
[![CodeQL](https://github.com/rcghpge/lnos/actions/workflows/github-code-scanning/codeql/badge.svg)](https://github.com/rcghpge/lnos/actions/workflows/github-code-scanning/codeql)
[![LnOS CI/CD](https://github.com/rcghpge/lnos/actions/workflows/ci-main.yml/badge.svg)](https://github.com/rcghpge/lnos/actions/workflows/ci-main.yml)

EOF
)

          awk '
            BEGIN {printed=0; in_badge=0}
            /^# lnos/ {print; in_badge=1; next}
            /^\[!\[.*\]\(https:\/\/github\.com\/rcghpge\/lnos\/actions\// {
              if (in_badge) next
            }
            {in_badge=0; print}
          ' "$README" > README.temp.md

          echo "$BADGE_BLOCK" | cat - README.temp.md > README.final.md

          if ! cmp -s "$README" README.final.md; then
            mv README.final.md "$README"
            git add "$README"
            git commit -m "ü§ñ Auto-update CI badge block for $BRANCH"
            git push
          else
            echo "‚úÖ README.md already up to date"
          fi

