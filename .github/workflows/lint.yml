name: ShellCheck

on:
  push:
    paths:
      - '**/*.sh'
      - '**/*.bash'
      - '**/*.zsh'
  pull_request:
    paths:
      - '**/*.sh'
      - '**/*.bash'
      - '**/*.zsh'

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest

    container: archlinux:latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Arch packages
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm shellcheck bash coreutils findutils grep

      - name: ðŸ” Find shell scripts
        id: list_shell_scripts
        run: |
          find . \( -name "*.sh" -o -name "*.bash" -o -name "*.zsh" \) -type f -not -path "./.git/*" > shell_files.txt
          FILE_COUNT=$(wc -l < shell_files.txt)
          echo "Found $FILE_COUNT shell script(s)."
          echo "file_count=$FILE_COUNT" >> "$GITHUB_OUTPUT"

      - name: ðŸ“‹ Run ShellCheck and emit SC codes as ::notice
        if: steps.list_shell_scripts.outputs.file_count != '0'
        shell: bash
        run: |
          while IFS= read -r file; do
            shellcheck --external-sources --severity=style "$file" 2>&1 | while IFS= read -r line; do
              if [[ "$line" =~ ^([^:]+):([0-9]+):([0-9]+):\ ([^:]+):\ (SC[0-9]+) ]]; then
                FILE="${BASH_REMATCH[1]}"
                LINE="${BASH_REMATCH[2]}"
                COL="${BASH_REMATCH[3]}"
                CODE="${BASH_REMATCH[5]}"
                echo "::notice file=$FILE,line=$LINE,col=$COL::$CODE"
              fi
            done
          done < shell_files.txt
